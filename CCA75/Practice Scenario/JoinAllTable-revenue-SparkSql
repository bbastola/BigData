Problem:

Get only completed orders (hint: order_state = ‘COMPLETE’)
Get revenue for each department per day

Hint: Join all tables except customers

Please provide following as output:

It should have order_date, department_name and revenue for each department)

solution using sparksql
---------------------------

sqlContext.sql("use xueling12_retail_db")
sqlContext.sql("show tables").show().    ---> this is just to verify

//revenue per department per day

sqlContext.sql("select substr(order_date, 1,10) order_date, department_name, round(sum(order_item_subtotal),2) revenue \
from orders join order_items on order_id = order_item_order_id \
join products on product_id = order_item_product_id \
join categories on category_id = product_category_id \
join departments on department_id = category_department_id \
where order_status = 'COMPLETE' \
group by substr(order_date, 1, 10), department_name \
order by order_date, revenue desc").show()

//revenue per department per day and total order count

sqlContext.sql("select substr(order_date, 1,10) order_date, department_name, round(sum(order_item_subtotal),2) revenue, \
count(order_item_subtotal) order_count from orders join order_items on order_id = order_item_order_id \
join products on product_id = order_item_product_id \
join categories on category_id = product_category_id \
join departments on department_id = category_department_id \
where order_status = 'COMPLETE' \
group by substr(order_date, 1, 10), department_name \
order by order_date, revenue desc").show()


//top 5 revenue per department per day

sqlContext.sql("select * from (select substr(order_date, 1,10) order_date, department_name, \
round(sum(order_item_subtotal),2) revenue, \
rank() over(partition by substr(order_date, 1,10) order by round(sum(order_item_subtotal),2)) revenue_position \
from orders join order_items on order_id = order_item_order_id \
join products on product_id = order_item_product_id \
join categories on category_id = product_category_id \
join departments on department_id = category_department_id \
where order_status = 'COMPLETE' \
group by substr(order_date, 1, 10), department_name) tmp \
where tmp.revenue_position <=5 \
order by order_date, revenue desc").show()


